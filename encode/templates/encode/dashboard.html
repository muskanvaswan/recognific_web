{% extends 'base.html' %}
{% load static %}
{% block additional_css %}<link rel="stylesheet" href="{% static 'css/index.css' %} ">
{% endblock %}

{% block title %}
Dashboard
{% endblock %}

{% block body %}
{% if user.teacher %}
<div class=" container p-5">
  <h1>Dashboard</h1>
  <div class="p-5">
    <h5>  Your Classes:</h5>
    <div class="d-flex">
      <p class="my-auto mr-2">Download Attendance for a</p>
      <select class="form-control w-25 m-2" name="option" id="option" value="day">
        <option value="day">Day</option>
        <option value="month">Month</option>
      </select>
    </div>
    <p>

    </p>
    <input type="date" name="date" id="date" value="0">
    <input type="hidden" name="month" id="month" value="0">

    <div>

      {% for ClassSet in classes %}
        <div>
          <div class="card m-3">
            <div class="card-body d-flex justify-content-between">
              <div>
                <h5>
                  <a href="{% url 'update_classset' ClassSet.id %}">
                    {{ ClassSet.name }}
                  </a>
                </h5>
                {% if ClassSet.active %}
                Active at <a class="text-info" href="http://127.0.0.1:8000/r/face/class{{ ClassSet.id }}/"><u>http://127.0.0.1:8000/r/face/class{{ ClassSet.id }}/</u></a>
                {% endif %}
              </div>
              <div class="d-flex">
                {% if not ClassSet.active %}
                <button type="button" class="btn btn-primary m-2"><a href="{% url 'activate' ClassSet.id %}">Activate</a></button>
                {% else %}
                <button type="button" class="btn btn-danger m-2"><a href="{% url 'deactivate' ClassSet.id %}">Deactivate</a></button>
                {% endif %}

                <button type="button" class="btn btn-primary m-2" data-classname="{{ ClassSet.id }}" onclick="attendance(this)"name="button">Make Attendance Sheet</button>
                <div id="{{ ClassSet.id }}" class="invisible">

                    <a href="{{ ClassSet.get_file_url }}" type="file/xlsx" download>
                      <button type="button" name="download" class="btn btn-success my-2">
                        <i class="fa fa-download"></i>
                      </button>
                    </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <a href="{% url 'create_classset' %}" class="btn btn-primary"> Create Class </a>
    <a href="{% url 'create_student' %}" class="btn btn-primary"> Create Student </a>


  </div>

</div>
{% endif %}
{% if user.student %}
<div class="container p-5">
  <div class="p-5">
    <div class="">
      <h5> Your Attendance</h5>
      {% for a in attendance %}
        <div>
          <div class="card m-3">
            <div class="card-body d-flex justify-content-between">
              <h5>{{ a.classname }}</h5>
              <h5>{{ a.attended }}/{{ a.total }}</h5>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <div>
      <h5>Last Attendended</h5>

      {% for attend in user.student.attendance.all %}
        <div>
          <div class="card m-3">
            <div class="card-body d-flex justify-content-between">
              <h5>{{ attend.classname.name }}</h5>
              <h5>{{ attend.time}}</h5>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

</div>


</div>
{% endif %}
{% if not user.teacher and not user.student %}
<h1>Invalid User Please Sign Up again </h1>
{% endif %}
{% endblock %}

{% block additional_js %}
<script type="text/javascript">
  function appendDownload(id){
    document.getElementById(id).className = '';

  }
  function updateDate(){
    if (document.getElementById('date')=='0' || document.getElementById('date')==0){
      return 0;
    }
    a = document.getElementById('date').value.split('-');
    a.forEach((item, index, arr) => {arr[index] = parseInt(item);})
    return a;
  }
  function attendance(e){
      date = updateDate()
      var data = JSON.stringify({"option":document.getElementById('option').value,"date":date, "month":document.getElementById('month').value});

      var xhr = new XMLHttpRequest();
      xhr.withCredentials = true;

      xhr.addEventListener("readystatechange", function() {
        if(this.readyState === 4) {
          console.log(this.responseText);
        }
      });

      xhr.open("POST", `http://127.0.0.1:8000/r/api/make_sheet/${e.dataset.classname}/`);

      xhr.send(data);
      window.setTimeout(appendDownload(e.dataset.classname) ,3000);
  }




</script>
{% endblock %}
